name: Deploy All Services

on:
  workflow_dispatch:
    inputs:
      deploy-infrastructure:
        description: "Deploy Bicep infrastructure first"
        required: false
        type: boolean
        default: false
      image-tag:
        description: "Image tag to deploy (default: latest)"
        required: false
        default: "latest"

jobs:
  infrastructure:
    name: Deploy Infrastructure
    if: inputs.deploy-infrastructure
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy Bicep
        uses: azure/arm-deploy@v2
        with:
          scope: resourcegroup
          resourceGroupName: ${{ secrets.AZURE_RESOURCE_GROUP }}
          template: infra/main.bicep
          parameters: >
            environment=dev
            containerRegistry=${{ secrets.ACR_LOGIN_SERVER }}
            containerRegistryUsername=${{ secrets.ACR_USERNAME }}
            containerRegistryPassword=${{ secrets.ACR_PASSWORD }}
            imageTag=${{ inputs.image-tag }}

  deploy-legacy-vehicle-db:
    name: Deploy Legacy Vehicle DB
    needs: [infrastructure]
    if: always() && (needs.infrastructure.result == 'success' || needs.infrastructure.result == 'skipped')
    runs-on: ubuntu-latest
    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Update Container App
        uses: azure/CLI@v2
        with:
          inlineScript: |
            az containerapp update \
              --name ips-legacy-vehicle-db \
              --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
              --image ${{ secrets.ACR_LOGIN_SERVER }}/ips-legacy-vehicle-db:${{ inputs.image-tag }}

  deploy-legacy-mainframe:
    name: Deploy Legacy Mainframe
    needs: [infrastructure]
    if: always() && (needs.infrastructure.result == 'success' || needs.infrastructure.result == 'skipped')
    runs-on: ubuntu-latest
    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Update Container App
        uses: azure/CLI@v2
        with:
          inlineScript: |
            az containerapp update \
              --name ips-legacy-mainframe \
              --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
              --image ${{ secrets.ACR_LOGIN_SERVER }}/ips-legacy-mainframe:${{ inputs.image-tag }}

  deploy-vehicle-service:
    name: Deploy Vehicle Service
    needs: [deploy-legacy-vehicle-db]
    runs-on: ubuntu-latest
    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Update Container App
        uses: azure/CLI@v2
        with:
          inlineScript: |
            az containerapp update \
              --name ips-vehicle-service \
              --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
              --image ${{ secrets.ACR_LOGIN_SERVER }}/ips-vehicle-service:${{ inputs.image-tag }}

  deploy-insurance-service:
    name: Deploy Insurance Service
    needs: [deploy-legacy-mainframe]
    runs-on: ubuntu-latest
    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Update Container App
        uses: azure/CLI@v2
        with:
          inlineScript: |
            az containerapp update \
              --name ips-insurance-service \
              --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
              --image ${{ secrets.ACR_LOGIN_SERVER }}/ips-insurance-service:${{ inputs.image-tag }}

  deploy-customer-service:
    name: Deploy Customer Service
    needs: [deploy-vehicle-service, deploy-insurance-service]
    runs-on: ubuntu-latest
    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Update Container App
        uses: azure/CLI@v2
        with:
          inlineScript: |
            az containerapp update \
              --name ips-customer-service \
              --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
              --image ${{ secrets.ACR_LOGIN_SERVER }}/ips-customer-service:${{ inputs.image-tag }}

  deploy-web:
    name: Deploy Web Client
    needs: [deploy-customer-service]
    runs-on: ubuntu-latest
    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Update Container App
        uses: azure/CLI@v2
        with:
          inlineScript: |
            az containerapp update \
              --name ips-web \
              --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
              --image ${{ secrets.ACR_LOGIN_SERVER }}/ips-web:${{ inputs.image-tag }}
